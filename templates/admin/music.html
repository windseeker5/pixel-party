{% extends "base.html" %}

{% block title %}Music Library Admin - {{ super() }}{% endblock %}

{% block navbar %}
<div class="navbar bg-base-300 mb-6">
    <div class="navbar-start">
        <div class="dropdown">
            <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                </svg>
            </div>
            <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                <li><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
                <li><a href="{{ url_for('admin.music_dashboard') }}" class="active">Music Library</a></li>
                <li><a href="{{ url_for('admin.settings') }}">Settings</a></li>
            </ul>
        </div>
    </div>
    <div class="navbar-center">
        <a class="btn btn-ghost text-xl">ðŸŽµ Music Admin</a>
    </div>
    <div class="navbar-end">
        <button class="btn btn-ghost btn-circle">
            <div class="indicator">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-4">
    
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="stat bg-base-100 rounded-lg shadow-lg">
            <div class="stat-figure text-primary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                </svg>
            </div>
            <div class="stat-title">Total Tracks</div>
            <div class="stat-value text-primary">{{ "{:,}".format(stats.total_tracks) }}</div>
        </div>
        
        <div class="stat bg-base-100 rounded-lg shadow-lg">
            <div class="stat-figure text-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
            </div>
            <div class="stat-title">Artists</div>
            <div class="stat-value text-secondary">{{ "{:,}".format(stats.total_artists) }}</div>
        </div>
        
        <div class="stat bg-base-100 rounded-lg shadow-lg">
            <div class="stat-figure text-accent">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
            </div>
            <div class="stat-title">Albums</div>
            <div class="stat-value text-accent">{{ "{:,}".format(stats.total_albums) }}</div>
        </div>
        
        <div class="stat bg-base-100 rounded-lg shadow-lg">
            <div class="stat-figure text-warning">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="stat-title">Duration</div>
            <div class="stat-value text-warning">
                {% set hours = (stats.total_duration // 3600) %}
                {% set minutes = ((stats.total_duration % 3600) // 60) %}
                {{ hours }}h {{ minutes }}m
            </div>
        </div>
    </div>

    <!-- Indexing Control Panel -->
    <div class="card bg-base-100 shadow-xl mb-8">
        <div class="card-body">
            <h2 class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Music Library Indexing
            </h2>
            
            {% if indexing_status.running %}
                <!-- Indexing in Progress -->
                <div class="alert alert-info">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Indexing in progress... Please wait.</span>
                </div>
                
                <!-- Progress Display -->
                <div id="progress-display" 
                     hx-get="{{ url_for('admin.music_indexing_status') }}"
                     hx-trigger="every 2s"
                     hx-swap="innerHTML">
                    <div class="space-y-4">
                        <div class="flex justify-between text-sm">
                            <span>Current: {{ indexing_status.current_file }}</span>
                            <span>{{ indexing_status.stats.indexed + indexing_status.stats.updated }} / {{ indexing_status.total }}</span>
                        </div>
                        <progress class="progress progress-primary w-full" value="{{ indexing_status.progress }}" max="100"></progress>
                        
                        <div class="stats stats-horizontal shadow">
                            <div class="stat">
                                <div class="stat-title">Indexed</div>
                                <div class="stat-value text-sm">{{ indexing_status.stats.indexed }}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-title">Updated</div>
                                <div class="stat-value text-sm">{{ indexing_status.stats.updated }}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-title">Errors</div>
                                <div class="stat-value text-sm">{{ indexing_status.stats.errors }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- Indexing Controls -->
                <div class="flex flex-wrap gap-4">
                    <form method="POST" action="{{ url_for('admin.start_music_indexing') }}" class="flex gap-2">
                        <button type="submit" name="force" value="false" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Start Indexing
                        </button>
                        
                        <button type="submit" name="force" value="true" class="btn btn-warning">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Force Re-index
                        </button>
                    </form>
                    
                    <form method="POST" action="{{ url_for('admin.clear_music_index') }}" class="flex gap-2" 
                          onsubmit="return confirm('Are you sure you want to clear the entire music index? This cannot be undone.')">
                        <button type="submit" class="btn btn-error btn-outline">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Clear Index
                        </button>
                    </form>
                </div>
                
                <div class="text-sm opacity-70 mt-4">
                    <p><strong>Start Indexing:</strong> Scan for new or modified files</p>
                    <p><strong>Force Re-index:</strong> Re-process all files (takes longer)</p>
                    <p><strong>Clear Index:</strong> Remove all indexed music from database</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Search Testing Interface -->
    <div class="card bg-base-100 shadow-xl mb-8">
        <div class="card-body">
            <h2 class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                Search Testing
            </h2>
            
            <div class="form-control">
                <div class="input-group">
                    <input id="search-input" type="text" placeholder="Search for Bob Dylan, rolling stone, etc..." 
                           class="input input-bordered flex-1"
                           hx-post="{{ url_for('admin.search_test') }}"
                           hx-trigger="input changed delay:500ms, keyup[key=='Enter']"
                           hx-target="#search-results"
                           hx-indicator="#search-loading">
                    <button class="btn btn-square">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
                <label class="label">
                    <span class="label-text-alt">Test case-insensitive search: try "bob dylan", "BOB DYLAN", "BoB dYlAn"</span>
                    <span id="search-loading" class="htmx-indicator loading loading-spinner loading-sm"></span>
                </label>
            </div>
            
            <!-- Search Results -->
            <div id="search-results" class="mt-4">
                <div class="text-center text-gray-500 py-8">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <p>Enter a search term to test the music library</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Tracks -->
    {% if recent_tracks %}
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Recently Indexed Tracks
            </h2>
            
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Artist</th>
                            <th>Album</th>
                            <th>Duration</th>
                            <th>Indexed</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for track in recent_tracks %}
                        <tr>
                            <td class="font-medium">{{ track.title }}</td>
                            <td>{{ track.artist }}</td>
                            <td class="text-sm opacity-70">{{ track.album }}</td>
                            <td class="text-sm">{{ track.duration_formatted }}</td>
                            <td class="text-xs opacity-60">
                                {{ track.indexed_at.strftime('%Y-%m-%d %H:%M') if track.indexed_at else 'Unknown' }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Handle search form submission
document.body.addEventListener('htmx:beforeRequest', function(evt) {
    if (evt.detail.target.id === 'search-results') {
        const input = document.getElementById('search-input');
        const query = input.value.trim();
        if (!query) {
            evt.preventDefault();
            return;
        }
        
        // Add query to form data
        const xhr = evt.detail.xhr;
        const formData = new FormData();
        formData.append('query', query);
        xhr.send(formData);
        evt.preventDefault();
    }
});

// Handle search results
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.target.id === 'search-results') {
        const response = evt.detail.xhr.response;
        try {
            const data = JSON.parse(response);
            const container = evt.detail.target;
            
            if (data.results && data.results.length > 0) {
                let html = `
                    <div class="alert alert-success mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Found ${data.count} result(s) for "${data.query}"</span>
                    </div>
                    <div class="space-y-2">
                `;
                
                data.results.forEach(track => {
                    html += `
                        <div class="card bg-base-200 shadow-sm">
                            <div class="card-body p-4">
                                <h3 class="font-bold">${track.title}</h3>
                                <p class="text-sm opacity-70">by ${track.artist}</p>
                                ${track.album ? `<p class="text-xs opacity-60">${track.album}</p>` : ''}
                                <div class="flex justify-between items-center mt-2">
                                    <span class="badge badge-outline">${track.duration_formatted}</span>
                                    <span class="badge badge-ghost">${track.source}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.664-.833-2.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z" />
                        </svg>
                        <span>No results found for "${data.query}". Try a different search term.</span>
                    </div>
                `;
            }
        } catch (e) {
            console.error('Error parsing search response:', e);
        }
    }
});

// Auto-refresh progress during indexing
function refreshProgress() {
    const progressDisplay = document.getElementById('progress-display');
    if (progressDisplay) {
        htmx.trigger(progressDisplay, 'refresh');
    }
}

// Check if indexing is running and set up auto-refresh
{% if indexing_status.running %}
setInterval(refreshProgress, 2000);
{% endif %}
</script>
{% endblock %}