<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonne fête Valérie!</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- daisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.24/dist/full.min.css" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Google Fonts for elegant script -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pinyon+Script&family=Tangerine:wght@400;700&family=Allura&display=swap" rel="stylesheet">
    
    <style>
        /* Remove all margins and padding for full screen */
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        /* Elegant script font for title */
        .birthday-title {
            font-family: 'Allura', cursive;
            background: linear-gradient(135deg, #ff6b9d, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Animated background for welcome screen */
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .animated-gradient {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        /* Full screen photo container */
        .photo-container {
            height: calc(100vh - 140px);
        }
        
        /* Compact volume slider */
        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            width: 60px;
        }
        
        .volume-slider::-webkit-slider-track {
            background: rgba(255, 255, 255, 0.1);
            height: 3px;
            border-radius: 2px;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #ff6b9d;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            margin-top: -4px;
        }
        
        .volume-slider::-moz-range-track {
            background: rgba(255, 255, 255, 0.1);
            height: 3px;
            border-radius: 2px;
        }
        
        .volume-slider::-moz-range-thumb {
            background: #ff6b9d;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            border: none;
        }
        
        /* Mini control buttons */
        .mini-control {
            padding: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .mini-control:hover {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-base-300 m-0 p-0">
    <!-- Main Big Screen Layout - Full Screen -->
    <div class="min-h-screen h-screen w-screen flex flex-col m-0 p-0 bg-base-300">
        <!-- Dark Header with proper height -->
        <div class="bg-base-200 text-white shadow-lg px-3 py-4 h-24">
            <div class="grid grid-cols-4 gap-3 h-full">
                <!-- Left section with clock and title centered in photo area -->
                <div class="col-span-3 flex items-center">
                    <!-- Clock on the left -->
                    <div class="text-gray-400 text-sm font-medium w-32" id="current-time"></div>
                    
                    <!-- Title centered in this 3-column area -->
                    <div class="flex-1 text-center">
                        <h1 class="birthday-title text-5xl font-bold whitespace-nowrap">
                            Bonne fête Valérie!
                        </h1>
                    </div>
                </div>
                
                <!-- Icons on the right -->
                <div class="col-span-1 flex gap-3 justify-end items-center">
                    <!-- Settings Icon -->
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="window.location.href='/admin/settings'" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        </svg>
                    </button>
                    <!-- Memory Book Icon -->
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="window.location.href='/admin/export'" title="Memory Book">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Area - Full Width -->
        <div class="flex-1 grid grid-cols-4 gap-3 p-3 bg-base-300">
            <!-- Photo Display - 75% width -->
            <div class="col-span-3 photo-container" id="photo-display">
                
                <!-- Welcome Screen (shown when no photos) -->
                <div id="welcome-screen" class="hero h-full animated-gradient rounded-xl shadow-2xl">
                    <div class="hero-content text-center">
                        <div class="max-w-md">
                            <h1 class="text-5xl font-bold text-white mb-3 drop-shadow-lg animate-pulse whitespace-nowrap">
                                Welcome to Valérie's
                            </h1>
                            <h2 class="text-4xl font-bold text-yellow-300 mb-6 drop-shadow-lg">
                                50th Birthday Party!
                            </h2>
                            <p class="text-xl text-white mb-8 drop-shadow">
                                Share your photos, wishes, and music
                            </p>
                            
                            <!-- Smaller QR Code Card -->
                            <div class="card bg-white/95 backdrop-blur p-6 shadow-2xl">
                                <h3 class="text-lg font-bold text-gray-800 mb-3">Join the Celebration!</h3>
                                <div id="qr-code" class="mx-auto mb-3"></div>
                                <p class="text-gray-700 font-semibold text-sm">Scan with your phone camera</p>
                                <p class="text-xs text-gray-500 mt-1" id="mobile-url"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Photo Content (populated via HTMX) -->
                <div id="photo-content" class="hidden h-full" 
                     hx-get="/api/current_photo" 
                     hx-trigger="every 8s"
                     hx-swap="innerHTML">
                    <!-- Photos will be loaded here -->
                </div>
            </div>

            <!-- Sidebar - 25% width -->
            <div class="col-span-1 space-y-2 overflow-y-auto">
                <!-- Compact Music Player matching other cards -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-2">
                        <div class="flex items-center justify-between mb-1">
                            <h2 class="card-title text-sm flex items-center gap-1">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                </svg>
                                Now Playing
                            </h2>
                            <!-- Larger QR Code for when photos start -->
                            <div id="mini-qr-container" class="hidden">
                                <div id="mini-qr" class="w-20 h-20 bg-white p-1 rounded-lg shadow-lg"></div>
                            </div>
                        </div>
                        
                        <!-- Song Info - Compact -->
                        <div class="mb-1">
                            <div class="text-xs font-medium truncate" id="song-title">Ready to Party!</div>
                            <div class="text-xs opacity-60 truncate" id="song-artist">Add songs from your phone</div>
                        </div>
                        
                        <!-- Mini Progress Bar -->
                        <div class="w-full bg-gray-700 rounded-full h-1 mb-1">
                            <div class="bg-pink-500 h-1 rounded-full transition-all" id="progress-bar" style="width: 0%"></div>
                        </div>
                        
                        <!-- Compact Controls in one line -->
                        <div class="flex items-center justify-between gap-1">
                            <!-- Play controls -->
                            <div class="flex items-center gap-1">
                                <button class="mini-control" onclick="previousSong()">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                                    </svg>
                                </button>
                                <button class="mini-control" onclick="togglePlay()">
                                    <svg id="play-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                    <svg id="pause-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                    </svg>
                                </button>
                                <button class="mini-control" onclick="nextSong()">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Volume -->
                            <div class="flex items-center gap-1">
                                <svg class="w-3 h-3 opacity-50" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                                </svg>
                                <input type="range" class="volume-slider" id="volume-control" 
                                       min="0" max="100" value="70" onchange="setVolume(this.value)">
                            </div>
                            
                            <!-- Time -->
                            <div class="text-xs opacity-50">
                                <span id="current-time-display">0:00</span>
                            </div>
                        </div>
                        
                        <!-- Hidden audio element -->
                        <audio id="audio-player" class="hidden"></audio>
                    </div>
                </div>

                <!-- Photo Queue -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-2">
                        <h2 class="card-title text-sm mb-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Photo Queue
                        </h2>
                        <div id="photo-queue" hx-get="/api/photos/queue" hx-trigger="every 5s">
                            <!-- Photo thumbnails -->
                        </div>
                    </div>
                </div>

                <!-- Music Queue -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-2">
                        <h2 class="card-title text-sm mb-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                            </svg>
                            Music Queue
                        </h2>
                        <div id="music-queue" hx-get="/api/music_queue" hx-trigger="every 5s">
                            <!-- Music queue items -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Minimal Dark Footer - No Guests -->
        <footer class="bg-base-200 text-gray-400 p-2">
            <div class="grid grid-cols-4 gap-3">
                <!-- Stats centered in the photo area (first 3 columns) -->
                <div class="col-span-3 flex justify-center space-x-6 text-xs">
                    <div class="flex items-center space-x-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span id="photo-count">0 Photos</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                        <span id="music-count">0 Songs</span>
                    </div>
                </div>
                <!-- Empty right column to match header layout -->
                <div class="col-span-1"></div>
            </div>
        </footer>
    </div>
    
    <!-- QR Code Library -->
    <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    
    <script>
        let audioPlayer = null;
        let hasPhotos = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize audio player
            audioPlayer = document.getElementById('audio-player');
            
            // Generate QR code with network IP
            generateQRCode();
            
            // Update clock
            updateClock();
            setInterval(updateClock, 1000);
            
            // Update stats
            updateStats();
            setInterval(updateStats, 5000);
            
            // Check for photos to start slideshow
            checkForPhotos();
            
            // Load music queue and current song
            loadMusicQueue();
            loadCurrentSong();
            setInterval(() => {
                loadMusicQueue();
            }, 10000);
            
            // Setup audio player event listeners
            setupAudioPlayer();
        });
        
        function generateQRCode() {
            // Fetch network info to get correct IP address
            fetch('/api/network_info')
                .then(response => response.json())
                .then(data => {
                    const qr = qrcode(4, 'L');
                    const url = data.mobile_url;
                    qr.addData(url);
                    qr.make();
                    
                    // Generate main QR code for welcome screen (doubled size)
                    const qrElement = document.getElementById('qr-code');
                    if (qrElement) {
                        qrElement.innerHTML = qr.createImgTag(6); // Reduced from 9 to 6
                    }
                    
                    // Generate larger QR for music player (when photos start)
                    const miniQrElement = document.getElementById('mini-qr');
                    if (miniQrElement) {
                        const miniQr = qrcode(4, 'L');
                        miniQr.addData(url);
                        miniQr.make();
                        miniQrElement.innerHTML = miniQr.createImgTag(6);  // Doubled from 4 to 6
                    }
                    
                    // Display URL
                    const urlElement = document.getElementById('mobile-url');
                    if (urlElement) {
                        urlElement.textContent = url;
                    }
                })
                .catch(error => {
                    console.error('Error fetching network info:', error);
                });
        }
        
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour12: true,
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('current-time').textContent = timeString;
        }
        
        function updateStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('photo-count').textContent = `${data.photos || 0} Photos`;
                    document.getElementById('music-count').textContent = `${data.music_requests || 0} Songs`;
                })
                .catch(error => console.error('Error updating stats:', error));
        }
        
        function checkForPhotos() {
            fetch('/api/photos')
                .then(response => response.json())
                .then(data => {
                    if (data.photos && data.photos.length > 0) {
                        if (!hasPhotos) {
                            hasPhotos = true;
                            // Hide welcome screen and show photo content
                            document.getElementById('welcome-screen').classList.add('hidden');
                            document.getElementById('photo-content').classList.remove('hidden');
                            
                            // Show mini QR code in music player
                            document.getElementById('mini-qr-container').classList.remove('hidden');
                            
                            // Start the HTMX polling if not already started
                            const photoContent = document.getElementById('photo-content');
                            if (!photoContent.hasAttribute('hx-trigger')) {
                                htmx.process(photoContent);
                            }
                        }
                    }
                })
                .catch(error => console.error('Error checking for photos:', error));
        }
        
        // Check for photos every 5 seconds
        setInterval(checkForPhotos, 5000);

        // Compact Music Player Functions
        function setupAudioPlayer() {
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', nextSong);
            audioPlayer.addEventListener('play', () => updatePlayButton(true));
            audioPlayer.addEventListener('pause', () => updatePlayButton(false));
            
            // Set initial volume
            audioPlayer.volume = 0.7;
        }
        
        function updateProgress() {
            if (audioPlayer && audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                document.getElementById('progress-bar').style.width = progress + '%';
                
                const current = formatTime(audioPlayer.currentTime);
                document.getElementById('current-time-display').textContent = current;
            }
        }
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
        
        function updatePlayButton(isPlaying) {
            document.getElementById('play-icon').classList.toggle('hidden', isPlaying);
            document.getElementById('pause-icon').classList.toggle('hidden', !isPlaying);
        }
        
        function togglePlay() {
            if (audioPlayer.src) {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            } else {
                // Load and play the first song in queue
                loadCurrentSong();
            }
        }
        
        function setVolume(value) {
            if (audioPlayer) {
                audioPlayer.volume = value / 100;
            }
        }
        
        function loadMusicQueue() {
            fetch('/api/music_queue')
                .then(response => response.json())
                .then(data => {
                    // Queue is handled by HTMX
                })
                .catch(error => console.error('Error loading music queue:', error));
        }
        
        function loadCurrentSong() {
            fetch('/api/music/current')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('song-title').textContent = 'Ready to Party!';
                        document.getElementById('song-artist').textContent = 'Add songs from your phone';
                        audioPlayer.src = '';
                    } else {
                        document.getElementById('song-title').textContent = data.title || 'Unknown Song';
                        document.getElementById('song-artist').textContent = data.artist || 'Unknown Artist';
                        
                        if (data.file_url && audioPlayer.src !== window.location.origin + data.file_url) {
                            audioPlayer.src = data.file_url;
                            audioPlayer.load();
                            // Auto-play when loading a new song
                            audioPlayer.play().catch(e => {
                                console.log('Auto-play prevented:', e);
                            });
                        }
                    }
                })
                .catch(error => console.error('Error loading current song:', error));
        }
        
        function nextSong() {
            fetch('/api/music/next', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    document.getElementById('song-title').textContent = data.title || 'Unknown Song';
                    document.getElementById('song-artist').textContent = data.artist || 'Unknown Artist';
                    
                    if (data.file_url) {
                        audioPlayer.src = data.file_url;
                        audioPlayer.load();
                        audioPlayer.play().catch(e => {
                            console.log('Auto-play prevented:', e);
                        });
                    }
                    
                    loadMusicQueue();
                } else {
                    document.getElementById('song-title').textContent = 'Ready to Party!';
                    document.getElementById('song-artist').textContent = 'Add songs from your phone';
                    audioPlayer.src = '';
                }
            })
            .catch(error => console.error('Error going to next song:', error));
        }

        function previousSong() {
            fetch('/api/music/previous', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    document.getElementById('song-title').textContent = data.title || 'Unknown Song';
                    document.getElementById('song-artist').textContent = data.artist || 'Unknown Artist';
                    
                    if (data.file_url) {
                        audioPlayer.src = data.file_url;
                        audioPlayer.load();
                        audioPlayer.play().catch(e => {
                            console.log('Auto-play prevented:', e);
                        });
                    }
                    
                    loadMusicQueue();
                } else {
                    console.log('No previous song:', data.error);
                }
            })
            .catch(error => console.error('Error going to previous song:', error));
        }
    </script>
</body>
</html>