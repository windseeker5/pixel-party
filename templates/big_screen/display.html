<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonne f√™te Val√©rie!</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- daisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.24/dist/full.min.css" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Google Fonts for elegant script -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pinyon+Script&family=Tangerine:wght@400;700&family=Allura&display=swap" rel="stylesheet">

    <!-- Emoji font support for consistent rendering across devices -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    
    <style>
        /* Emoji font support for consistent rendering across all devices */
        body, html, .wish-text, .emoji-support, #submitter-wish, #song-title, #song-artist {
            font-family: 'Inter', 'Segoe UI', 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Android Emoji', 'EmojiSymbols', 'EmojiOne Mozilla', 'Twemoji Mozilla', 'Segoe UI Symbol', sans-serif;
        }

        /* Specific emoji rendering styles */
        .emoji-text, #submitter-wish {
            font-feature-settings: "liga" 1, "kern" 1;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Remove all margins and padding for full screen */
        body, html {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
        }

        /* Desktop: Hide overflow for full-screen experience */
        @media (min-width: 1024px) {
            body, html {
                overflow: hidden;
            }
        }

        /* Mobile: Allow scrolling */
        @media (max-width: 1023px) {
            body, html {
                overflow-y: auto;
            }
        }

        /* Elegant script font for title */
        .birthday-title {
            font-family: 'Allura', cursive;
            background: linear-gradient(135deg, #ff6b9d, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* Animated background for welcome screen */
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .animated-gradient {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        /* Full screen photo container with smooth transitions */
        .photo-container {
            height: calc(100vh - 140px);
        }

        /* Mobile-specific photo container */
        @media (max-width: 1023px) {
            .photo-container {
                height: 50vh;
                min-height: 300px;
            }
        }

        /* Desktop suggestion banner */
        .desktop-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }

        /* Show banner only on mobile */
        @media (max-width: 1023px) {
            .desktop-banner {
                display: block;
            }
        }

        .desktop-banner.hidden {
            display: none !important;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 1023px) {
            /* Responsive grid - stack vertically on mobile */
            .mobile-stack {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            /* Hide desktop-only elements on mobile */
            .desktop-only {
                display: none !important;
            }

            /* Show mobile-only elements */
            .mobile-only {
                display: block !important;
            }

            /* Compact header on mobile */
            .mobile-header {
                padding: 8px 16px !important;
                height: auto !important;
            }

            .birthday-title {
                font-size: 2rem !important;
            }

            /* Collapsible sections */
            .mobile-collapsible {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .mobile-collapsible.expanded {
                max-height: 400px;
            }
        }

        /* Mini control buttons */
        .mini-control {
            padding: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            transition: background 0.2s;
        }

        .mini-control:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Mobile touch-friendly controls */
        @media (max-width: 1023px) {
            .mini-control {
                padding: 8px;
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* Pulse animation for attention */
        @keyframes gentle-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .pulse-gentle {
            animation: gentle-pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-base-300 m-0 p-0">
    <!-- Mobile Desktop Suggestion Banner -->
    <div id="desktop-banner" class="desktop-banner">
        <div class="flex items-center justify-center gap-3">
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5 pulse-gentle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25h-9A2.25 2.25 0 002.25 7.5v9a2.25 2.25 0 002.25 2.25z"></path>
                </svg>
                <span class="text-sm font-medium">üé≠ DJ Automatique LIVE - Meilleur sur grand √©cran!</span>
            </div>
            <button onclick="dismissDesktopBanner()" class="text-white hover:text-yellow-200 transition-colors ml-2" title="Fermer">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="text-xs opacity-90 mt-1 flex items-center justify-center gap-3">
            <span class="flex items-center gap-1">
                üì∏ <span>Slideshow temps r√©el</span>
            </span>
            <span class="flex items-center gap-1">
                üíù <span>V≈ìux automatiques</span>
            </span>
            <span class="flex items-center gap-1">
                üéµ <span>Musique partag√©e</span>
            </span>
        </div>
    </div>

    <!-- Main Big Screen Layout - Full Screen -->
    <div class="min-h-screen h-screen w-screen flex flex-col m-0 p-0 bg-base-300">
        <!-- Dark Header with proper height -->
        <div class="bg-base-300 text-white shadow-lg px-3 py-4 h-24 mobile-header">
            <div class="grid grid-cols-4 gap-3 h-full mobile-stack">
                <!-- Left section with title centered in photo area -->
                <div class="col-span-3 flex items-center">
                    <!-- Title centered in this 3-column area -->
                    <div class="flex-1 text-center">
                        <h1 class="birthday-title text-5xl font-bold whitespace-nowrap">
                            Bonne f√™te Val√©rie!
                        </h1>
                    </div>
                </div>

                <!-- Icons and clock on the right -->
                <div class="col-span-1 flex gap-3 justify-end items-center desktop-only">
                    <!-- Clock moved to right -->
                    <div class="text-gray-400 text-sm font-medium" id="current-time"></div>
                    <!-- Admin Management Icon -->
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="window.location.href='/admin/manage'" title="Admin Management">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        </svg>
                    </button>
                    <!-- Memory Book Icon -->
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="window.location.href='/admin/export'" title="Memory Book">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                        </svg>
                    </button>
                </div>

                <!-- Mobile-only controls -->
                <div class="col-span-1 hidden mobile-only flex justify-center items-center gap-2">
                    <div class="text-gray-400 text-xs" id="current-time-mobile"></div>
                </div>
            </div>
        </div>

        <!-- Main Content Area - Full Width -->
        <div class="flex-1 grid grid-cols-4 gap-3 p-3 bg-base-300 mobile-stack">
            <!-- Photo Display - 75% width -->
            <div class="col-span-3 photo-container" id="photo-display">
                
                <!-- Welcome Screen (shown when no photos) -->
                <div id="welcome-screen" class="hero h-full animated-gradient rounded-xl shadow-2xl">
                    <div class="hero-content text-center w-full">
                        <div class="max-w-4xl w-full">
                            <h1 class="text-5xl font-bold text-white mb-3 drop-shadow-lg animate-pulse text-center">
                                Bienvenue √† la f√™te de Val√©rie
                            </h1>
                            <h2 class="text-4xl font-bold text-yellow-300 mb-6 drop-shadow-lg text-center">
                                50e anniversaire!
                            </h2>
                            <p class="text-xl text-white mb-8 drop-shadow text-center">
                                Partagez vos photos, v≈ìux et musique
                            </p>

                            <!-- QR Code Card - Centered -->
                            <div class="flex justify-center max-w-md mx-auto">
                                <!-- QR Code Card -->
                                <div class="card bg-white/95 backdrop-blur p-8 shadow-2xl">
                                    <div class="card-body items-center text-center p-0 flex flex-col justify-center h-full">
                                        <div id="qr-code" class="mb-4"></div>
                                        <h3 class="text-lg font-bold text-gray-800">Partagez un moment</h3>
                                        <p class="text-xs text-gray-500 mt-1" id="mobile-url"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Photo Content (populated via HTMX) -->
                <div id="photo-content" class="hidden h-full"
                     hx-get="{{ url_for('api.current_photo') }}"
                     hx-trigger="nextPhoto"
                     hx-swap="innerHTML">
                    <!-- Photos will be loaded here -->
                </div>
            </div>

            <!-- Sidebar - 25% width on desktop, full width on mobile -->
            <div class="col-span-1 space-y-2 overflow-y-auto">
                <!-- Compact Music Player matching other cards -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-2">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex-1">
                                <h2 class="card-title text-sm flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                    </svg>
                                    Ambiance sugg√©r√©e par
                                </h2>
                                <!-- Submitter Info - Right below "Now Playing" title -->
                                <div class="flex items-center gap-2" id="submitter-info" style="display: none;">
                                    <div class="font-bold text-pink-400" id="submitter-name" style="font-size: 1.5625rem;">Elizabeth</div>
                                </div>
                                <!-- Wish message below name -->
                                <div class="text-sm italic text-gray-300 mt-1 pr-8 leading-5" id="submitter-wish" style="display: none;">
                                </div>
                            </div>
                            <!-- Larger QR Code for when photos start - Desktop only -->
                            <div id="mini-qr-container" class="hidden desktop-only">
                                <div id="mini-qr" class="w-32 h-32 bg-white p-1 rounded-lg shadow-lg"></div>
                            </div>
                        </div>

                        <!-- Song Info - Compact -->
                        <div class="mb-1">
                            <div class="text-xs font-medium truncate" id="song-title">Ready to Party!</div>
                            <div class="text-xs opacity-60 truncate" id="song-artist">Add songs from your phone</div>
                        </div>

                        <!-- Mini Progress Bar -->
                        <div class="w-full bg-gray-700 rounded-full h-1 mb-1">
                            <div class="bg-pink-500 h-1 rounded-full transition-all" id="progress-bar" style="width: 0%"></div>
                        </div>

                        <!-- Compact Controls in one line -->
                        <div class="flex items-center justify-between gap-1">
                            <!-- Play controls - DEAD SIMPLE -->
                            <div class="flex items-center gap-1">
                                <button class="mini-control" id="prev-btn">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                                    </svg>
                                </button>
                                <button class="mini-control" id="play-pause-btn">
                                    <svg id="play-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                    <svg id="pause-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                    </svg>
                                </button>
                                <button class="mini-control" id="next-btn">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                                    </svg>
                                </button>
                            </div>

                            <!-- Time -->
                            <div class="text-xs opacity-50">
                                <span id="current-time-display">0:00</span>
                            </div>
                        </div>

                        <!-- Hidden audio element -->
                        <audio id="audio-player" class="hidden" preload="auto"></audio>
                    </div>
                </div>

                <!-- Mobile Experience Explanation -->
                <div class="mobile-only hidden card bg-gradient-to-br from-purple-600 to-pink-600 shadow-xl">
                    <div class="card-body p-3 text-center text-white">
                        <h3 class="text-sm font-bold mb-2">üé≠ Exp√©rience DJ Automatique LIVE</h3>
                        <div class="text-xs opacity-90 mb-3 space-y-1">
                            <div class="flex items-center justify-center gap-2">
                                <span>üì∏</span>
                                <span>Photos de tous ‚Üí Slideshow automatique</span>
                            </div>
                            <div class="flex items-center justify-center gap-2">
                                <span>üíù</span>
                                <span>Vos v≈ìux ‚Üí Affichage temps r√©el</span>
                            </div>
                            <div class="flex items-center justify-center gap-2">
                                <span>üéµ</span>
                                <span>Suggestions musicales ‚Üí Mix automatique</span>
                            </div>
                        </div>
                        <div class="text-xs bg-white/20 rounded p-2 mb-2">
                            <strong>Vous manquez l'automation LIVE!</strong><br/>
                            Trouvez un grand √©cran pour voir la magie op√©rer üì∫
                        </div>
                    </div>
                </div>

                <!-- Mobile QR Code Section -->
                <div class="mobile-only hidden card bg-base-200 shadow-xl">
                    <div class="card-body p-3 text-center">
                        <h3 class="text-sm font-medium text-white mb-2">üì± Participez √† l'exp√©rience</h3>
                        <div id="mobile-qr-container" class="flex justify-center">
                            <div id="mobile-qr" class="w-24 h-24 bg-white p-1 rounded-lg shadow-lg"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Scannez pour ajouter photos, v≈ìux et musique</p>
                    </div>
                </div>

                <!-- Music Queue - Collapsible on Mobile -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-2">
                        <button class="w-full mobile-only hidden" onclick="toggleMobileSection('music-queue-content')"
                                style="display: none;">
                            <div class="flex items-center justify-between">
                                <h2 class="card-title text-sm">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                    </svg>
                                    File d'attente musicale
                                </h2>
                                <svg class="w-4 h-4 transition-transform" id="music-queue-chevron">
                                    <path stroke="currentColor" stroke-width="2" d="m6 9 6 6 6-6"/>
                                </svg>
                            </div>
                        </button>

                        <h2 class="card-title text-sm mb-1 desktop-only">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                            </svg>
                            Music Queue
                        </h2>

                        <div id="music-queue-content" class="mobile-collapsible">
                            <div id="music-queue" hx-get="/api/music_queue" hx-trigger="every 5s">
                                <!-- Music queue items -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Photo Queue - Collapsible on Mobile -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-2">
                        <button class="w-full mobile-only hidden" onclick="toggleMobileSection('photo-queue-content')"
                                style="display: none;">
                            <div class="flex items-center justify-between">
                                <h2 class="card-title text-sm">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    File d'attente photos
                                </h2>
                                <svg class="w-4 h-4 transition-transform" id="photo-queue-chevron">
                                    <path stroke="currentColor" stroke-width="2" d="m6 9 6 6 6-6"/>
                                </svg>
                            </div>
                        </button>

                        <h2 class="card-title text-sm mb-1 desktop-only">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Photo Queue
                        </h2>

                        <div id="photo-queue-content" class="mobile-collapsible">
                            <div id="photo-queue" hx-get="/api/photos/queue" hx-trigger="every 5s">
                                <!-- Photo thumbnails -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Minimal Dark Footer - No Guests -->
        <footer class="bg-base-300 text-gray-400 p-2">
            <div class="grid grid-cols-4 gap-3">
                <!-- Stats centered in the photo area (first 3 columns) -->
                <div class="col-span-3 flex justify-center space-x-6 text-xs">
                    <div class="flex items-center space-x-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span id="photo-count">0 Photos</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                        <span id="music-count">0 Songs</span>
                    </div>
                </div>
                <!-- Empty right column to match header layout -->
                <div class="col-span-1"></div>
            </div>
        </footer>
    </div>
    
    <!-- QR Code Library -->
    <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    
    <script>
        let audioPlayer = null;
        let hasPhotos = false;

        // Global functions for photo_display.html compatibility
        window.adjustImageDisplay = function(img) {
            // This function is called from photo_display.html
            // Just prevent the error - the function in photo_display.html will handle the logic
            console.log('adjustImageDisplay called for', img);
        };

        window.adjustVideoDisplay = function(video) {
            // This function is called from photo_display.html
            // Provide basic video handling
            if (video && typeof video.addEventListener === 'function') {
                video.addEventListener('loadedmetadata', function() {
                    const duration = this.duration || {{ slideshow_duration }}; // default from database setting
                    if (window.parent && duration > 0) {
                        window.parent.postMessage({
                            type: 'video_duration',
                            duration: Math.ceil(duration)
                        }, '*');
                    }
                });
            }
        };

        // Global nextSong function for audio player
        window.nextSong = function() {
            // This will be implemented by the music player functionality
            console.log('Next song triggered');
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize audio player
            audioPlayer = document.getElementById('audio-player');

            // Generate QR code with network IP
            generateQRCode();

            // Update clock
            updateClock();
            setInterval(updateClock, 1000);

            // Update stats
            updateStats();
            setInterval(updateStats, 5000);

            // Check for photos to start slideshow
            checkForPhotos();

            // Load current song (music queue handled by HTMX)
            loadCurrentSong();

            // Setup audio player event listeners
            setupAudioPlayer();

            // Initialize mobile features
            initializeMobileFeatures();
        });

        // Mobile-specific initialization
        function initializeMobileFeatures() {
            // Show/hide mobile-only elements based on screen size
            const isMobile = window.innerWidth < 1024;

            if (isMobile) {
                // Show mobile-only elements
                document.querySelectorAll('.mobile-only').forEach(el => {
                    el.classList.remove('hidden');
                    if (el.style.display === 'none') el.style.display = 'block';
                });

                // Show mobile collapsible buttons
                document.querySelectorAll('.mobile-only button').forEach(btn => {
                    btn.style.display = 'block';
                });
            }

            // Handle window resize for responsive behavior
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    const newIsMobile = window.innerWidth < 1024;
                    if (newIsMobile !== isMobile) {
                        location.reload(); // Simple way to handle layout changes
                    }
                }, 250);
            });
        }

        // Dismiss desktop banner function
        function dismissDesktopBanner() {
            const banner = document.getElementById('desktop-banner');
            banner.classList.add('hidden');

            // Remember preference in localStorage
            try {
                localStorage.setItem('pixelparty_desktop_banner_dismissed', 'true');
            } catch (e) {
                // Ignore localStorage errors
            }
        }

        // Toggle mobile collapsible sections
        function toggleMobileSection(sectionId) {
            const section = document.getElementById(sectionId);
            const chevron = document.getElementById(sectionId.replace('-content', '-chevron'));

            if (section.classList.contains('expanded')) {
                section.classList.remove('expanded');
                if (chevron) chevron.style.transform = 'rotate(0deg)';
            } else {
                section.classList.add('expanded');
                if (chevron) chevron.style.transform = 'rotate(180deg)';
            }
        }

        // Check if desktop banner should be shown (not dismissed before)
        function checkDesktopBannerVisibility() {
            try {
                const dismissed = localStorage.getItem('pixelparty_desktop_banner_dismissed');
                if (dismissed === 'true') {
                    const banner = document.getElementById('desktop-banner');
                    if (banner) banner.classList.add('hidden');
                }
            } catch (e) {
                // Ignore localStorage errors
            }
        }

        // Initialize banner visibility check
        document.addEventListener('DOMContentLoaded', checkDesktopBannerVisibility);
        
        function generateQRCode() {
            // Fetch network info to get correct IP address
            fetch('/api/network_info')
                .then(response => response.json())
                .then(data => {
                    const qr = qrcode(4, 'L');
                    const url = data.mobile_url;
                    qr.addData(url);
                    qr.make();
                    
                    // Generate main QR code for welcome screen (doubled size)
                    const qrElement = document.getElementById('qr-code');
                    if (qrElement) {
                        qrElement.innerHTML = qr.createImgTag(6); // Reduced from 9 to 6
                    }
                    
                    // Generate larger QR for music player (when photos start)
                    const miniQrElement = document.getElementById('mini-qr');
                    if (miniQrElement) {
                        const miniQr = qrcode(4, 'L');
                        miniQr.addData(url);
                        miniQr.make();
                        miniQrElement.innerHTML = miniQr.createImgTag(8);  // Increased from 6 to 8 for bigger QR
                    }

                    // Generate mobile QR code
                    const mobileQrElement = document.getElementById('mobile-qr');
                    if (mobileQrElement) {
                        const mobileQr = qrcode(4, 'L');
                        mobileQr.addData(url);
                        mobileQr.make();
                        mobileQrElement.innerHTML = mobileQr.createImgTag(6);  // Smaller size for mobile
                    }
                    
                    // Display URL
                    const urlElement = document.getElementById('mobile-url');
                    if (urlElement) {
                        urlElement.textContent = url;
                    }

                    // Header URL display removed - admin can see URL in /admin/manage
                })
                .catch(error => {
                    console.error('Error fetching network info:', error);
                    // Header URL display removed - errors handled gracefully
                });
        }
        
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour12: true,
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit'
            });
            const currentTimeEl = document.getElementById('current-time');
            if (currentTimeEl) currentTimeEl.textContent = timeString;

            // Update mobile clock
            const currentTimeMobileEl = document.getElementById('current-time-mobile');
            if (currentTimeMobileEl) currentTimeMobileEl.textContent = timeString;
        }
        
        function updateStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('photo-count').textContent = `${data.photos || 0} Photos`;
                    document.getElementById('music-count').textContent = `${data.music_requests || 0} Songs`;
                })
                .catch(error => console.error('Error updating stats:', error));
        }
        
        function checkForPhotos() {
            fetch('/api/photos')
                .then(response => response.json())
                .then(data => {
                    if (data.photos && data.photos.length > 0) {
                        if (!hasPhotos) {
                            hasPhotos = true;
                            // Hide welcome screen and show photo content
                            document.getElementById('welcome-screen').classList.add('hidden');
                            document.getElementById('photo-content').classList.remove('hidden');
                            
                            // Show mini QR code in music player
                            document.getElementById('mini-qr-container').classList.remove('hidden');
                            
                            // Trigger the first photo load immediately
                            const photoContent = document.getElementById('photo-content');
                            triggerNextPhoto();
                        }
                    }
                })
                .catch(error => console.error('Error checking for photos:', error));
        }
        
        // Check for photos every 5 seconds
        setInterval(checkForPhotos, 5000);

        // Photo slideshow timer variables
        let photoTimer = null;
        let defaultPhotoDuration = {{ slideshow_duration }}; // seconds from database setting

        // Listen for HTMX content updates to check for videos
        document.addEventListener('htmx:afterSwap', function(event) {
            if (event.target.id === 'photo-content') {
                checkPhotoContent(event.target);
            }
        });

        function checkPhotoContent(container) {
            // Look for video element
            const video = container.querySelector('video');
            if (video) {
                // Get duration from data attribute first (more reliable)
                const dataDuration = parseFloat(video.getAttribute('data-duration'));
                if (dataDuration && dataDuration > 0) {
                    setPhotoTimer(Math.ceil(dataDuration));
                } else {
                    // Fallback to video duration when metadata loads
                    video.addEventListener('loadedmetadata', function() {
                        const duration = Math.ceil(this.duration) || defaultPhotoDuration;
                        setPhotoTimer(duration);
                    });
                }
            } else {
                // It's an image, use default timing
                setPhotoTimer(defaultPhotoDuration);
            }
        }

        function setPhotoTimer(duration) {
            // Clear existing timer
            if (photoTimer) {
                clearTimeout(photoTimer);
            }

            // Set new timer to trigger next photo
            photoTimer = setTimeout(function() {
                triggerNextPhoto();
            }, duration * 1000);
        }

        function triggerNextPhoto() {
            const photoContent = document.getElementById('photo-content');
            if (photoContent) {
                htmx.trigger(photoContent, 'nextPhoto');
            }
        }

        // Compact Music Player Functions
        function setupAudioPlayer() {
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', nextSong);
            audioPlayer.addEventListener('play', () => updatePlayButton(true));
            audioPlayer.addEventListener('pause', () => updatePlayButton(false));
        }
        
        function updateProgress() {
            if (audioPlayer && audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                document.getElementById('progress-bar').style.width = progress + '%';
                
                const current = formatTime(audioPlayer.currentTime);
                document.getElementById('current-time-display').textContent = current;
            }
        }
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
        
        function updatePlayButton(isPlaying) {
            document.getElementById('play-icon').classList.toggle('hidden', isPlaying);
            document.getElementById('pause-icon').classList.toggle('hidden', !isPlaying);
        }
        
        function togglePlay() {
            if (audioPlayer.src) {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            } else {
                // Load and play the first song in queue
                loadCurrentSong();
            }
        }
        
        
        // Music queue is handled by HTMX polling, no JavaScript needed
        
        function loadCurrentSong() {
            fetch('/api/music/current')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('song-title').textContent = 'Ready to Party!';
                        document.getElementById('song-artist').textContent = 'Add songs from your phone';
                        document.getElementById('submitter-info').style.display = 'none';
                        document.getElementById('submitter-wish').style.display = 'none';
                        audioPlayer.src = '';
                    } else {
                        document.getElementById('song-title').textContent = data.title || 'Unknown Song';
                        document.getElementById('song-artist').textContent = data.artist || 'Unknown Artist';
                        
                        // Show submitter info
                        document.getElementById('submitter-name').textContent = data.guest_name || 'Anonymous';
                        document.getElementById('submitter-info').style.display = 'flex';

                        // Show real wish if available
                        const wishElement = document.getElementById('submitter-wish');
                        if (data.guest_wish) {
                            wishElement.textContent = data.guest_wish;
                            wishElement.style.display = 'block';
                        } else {
                            wishElement.style.display = 'none';
                        }
                        
                        if (data.file_url && audioPlayer.src !== window.location.origin + data.file_url) {
                            audioPlayer.src = data.file_url;
                            audioPlayer.load();
                            // Auto-play when loading a new song
                            audioPlayer.play().catch(e => {
                                console.log('Auto-play prevented:', e);
                            });
                        }
                    }
                })
                .catch(error => console.error('Error loading current song:', error));
        }
        
        // DEAD SIMPLE - Music control buttons
        document.getElementById('play-pause-btn').addEventListener('click', function() {
            if (audioPlayer && audioPlayer.src) {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            }
        });

        document.getElementById('next-btn').addEventListener('click', function() {
            fetch('/api/music/next', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.file_url) {
                        // Update song info WITHOUT reloading
                        document.getElementById('song-title').textContent = data.title || 'Unknown Song';
                        document.getElementById('song-artist').textContent = data.artist || 'Unknown Artist';

                        // Update audio player
                        audioPlayer.src = data.file_url;
                        audioPlayer.load();
                        audioPlayer.play();

                        // Update submitter info if it exists
                        if (document.getElementById('submitter-name')) {
                            document.getElementById('submitter-name').textContent = data.guest_name || 'Anonymous';
                        }
                    } else {
                        alert('No songs ready yet. Still downloading...');
                    }
                })
                .catch(err => console.log('Next failed:', err));
        });

        document.getElementById('prev-btn').addEventListener('click', function() {
            fetch('/api/music/previous', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.file_url) {
                        // Update song info WITHOUT reloading
                        document.getElementById('song-title').textContent = data.title || 'Unknown Song';
                        document.getElementById('song-artist').textContent = data.artist || 'Unknown Artist';

                        // Update audio player
                        audioPlayer.src = data.file_url;
                        audioPlayer.load();
                        audioPlayer.play();

                        // Update submitter info if it exists
                        if (document.getElementById('submitter-name')) {
                            document.getElementById('submitter-name').textContent = data.guest_name || 'Anonymous';
                        }
                    } else {
                        alert('No previous song available');
                    }
                })
                .catch(err => console.log('Previous failed:', err));
        });
    </script>
</body>
</html>