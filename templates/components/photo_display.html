<!-- Photo/Video Display with Ken Burns effect and text overlay -->
<div class="relative w-full h-full overflow-hidden rounded-2xl bg-black">
    {% set file_ext = photo.filename.split('.')[-1].lower() %}
    {% set video_extensions = ['mp4', 'mov', 'avi', 'mkv', 'webm'] %}
    {% set is_video = file_ext in video_extensions or (photo.file_type and photo.file_type == 'video') %}

    {% if is_video %}
        <!-- Video with Ken Burns effect -->
        <video src="/media/photos/{{ photo.filename }}"
               autoplay
               playsinline
               preload="auto"
               volume="0.7"
               class="absolute inset-0 w-full h-full object-contain ken-burns-animation"
               data-duration="{{ photo.duration or 0 }}"
               onloadeddata="console.log('Video loaded:', '{{ photo.filename }}'); this.currentTime = 0; adjustVideoDisplay(this);"
               onended="notifyVideoEnded(this);"
               onerror="console.error('Video error:', '{{ photo.filename }}', this.error);"
               oncanplay="console.log('Video can play:', '{{ photo.filename }}');">
            <source src="/media/photos/{{ photo.filename }}" type="video/{{ file_ext }}">
            <p class="text-white text-center p-4">
                Video format not supported by your browser.<br>
                File: {{ photo.filename }}
            </p>
        </video>
    {% else %}
        <!-- Photo with Ken Burns effect -->
        <img src="/media/photos/{{ photo.filename }}"
             alt="Photo from {{ photo.guest_name }}"
             class="absolute inset-0 w-full h-full object-contain ken-burns-animation"
             onload="adjustImageDisplay(this)">
    {% endif %}
    
    <!-- SIMPLE TikTok-style text overlay - NO JAVASCRIPT -->
    {% if photo.wish_message %}
    <div class="tiktok-overlay tiktok-position-{{ (photo.id % 5) + 1 }}">
        <!-- Main wish text with random animation style and dynamic sizing -->
        {% if (photo.id % 4) + 1 == 1 %}
            <!-- Style 1: Typewriter effect with JavaScript -->
            <div class="tiktok-wish tiktok-style-1 {% if photo.wish_message|length <= 30 %}text-extra-large{% elif photo.wish_message|length <= 60 %}text-large{% elif photo.wish_message|length <= 100 %}text-medium{% else %}text-small{% endif %}"
                 data-text="{{ photo.wish_message|e }}">
                {{ photo.wish_message }}
            </div>
        {% else %}
            <!-- Style 2, 3 & 4: Direct text display (no JavaScript) -->
            {% set style_num = (photo.id % 4) + 1 %}
            {% if style_num == 2 %}
                <!-- Style 2 with color rotation -->
                {% set color_variant = ['blue', 'pink', 'orange'][photo.id % 3] %}
                <div class="tiktok-wish tiktok-style-2-{{ color_variant }} {% if photo.wish_message|length <= 30 %}text-extra-large{% elif photo.wish_message|length <= 60 %}text-large{% elif photo.wish_message|length <= 100 %}text-medium{% else %}text-small{% endif %}">
                    {{ photo.wish_message }}
                </div>
            {% else %}
                <!-- Other styles (3 & 4) -->
                <div class="tiktok-wish tiktok-style-{{ style_num }} {% if photo.wish_message|length <= 30 %}text-extra-large{% elif photo.wish_message|length <= 60 %}text-large{% elif photo.wish_message|length <= 100 %}text-medium{% else %}text-small{% endif %}">
                    {{ photo.wish_message }}
                </div>
            {% endif %}
        {% endif %}
        
        <!-- Sender name with random color -->
        <div class="tiktok-name name-color-{{ (photo.id % 5) + 1 }}">
            - {{ photo.guest_name }}
        </div>
    </div>
    {% endif %}
</div>

<style>
/* Ken Burns effect for photos and videos */
@keyframes kenBurnsSimple {
    0% { transform: scale(1.0) translate(0, 0); }
    100% { transform: scale(1.05) translate(-0.5%, -0.5%); }
}

@keyframes kenBurnsVertical {
    0% { transform: scale(1.0) translate(0, 0); }
    100% { transform: scale(1.02) translate(0, -0.3%); }
}

.ken-burns-animation {
    animation: kenBurnsSimple 8s ease-out forwards;
}

.ken-burns-vertical {
    animation: kenBurnsVertical 8s ease-out forwards;
}

.ken-burns-video {
    animation: none;
}

/* TikTok overlay container - Base positioning */
.tiktok-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    pointer-events: none;
    z-index: 10;
    padding: 0 5%;
}

/* Position 1: Top area */
.tiktok-position-1 {
    justify-content: flex-start;
    padding-top: 20%;
}

/* Position 2: Upper-middle area */
.tiktok-position-2 {
    justify-content: flex-start;
    padding-top: 35%;
}

/* Position 3: Center (original) */
.tiktok-position-3 {
    justify-content: center;
}

/* Position 4: Lower-middle area */
.tiktok-position-4 {
    justify-content: flex-end;
    padding-bottom: 35%;
}

/* Position 5: Bottom area */
.tiktok-position-5 {
    justify-content: flex-end;
    padding-bottom: 20%;
}

/* Base TikTok text style with dynamic sizing and emoji support */
.tiktok-wish {
    font-weight: 900;
    color: white;
    text-transform: uppercase;
    letter-spacing: 2px;
    line-height: 0.9;
    margin-bottom: 2rem;
    text-shadow: 3px 3px 0px rgba(0,0,0,1);
    max-width: 80%;
    word-wrap: break-word;
    /* Font stack with good emoji support */
    font-family: system-ui, -apple-system, 'Segoe UI', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif;
}

/* Enhanced dynamic font sizing based on text length */
.tiktok-wish.text-extra-large {
    font-size: clamp(3.5rem, 8vw, 6rem); /* 1-30 chars */
}

.tiktok-wish.text-large {
    font-size: clamp(3rem, 7vw, 5rem); /* 31-60 chars */
}

.tiktok-wish.text-medium {
    font-size: clamp(2.5rem, 6vw, 4rem); /* 61-100 chars */
}

.tiktok-wish.text-small {
    font-size: clamp(2rem, 5vw, 3.5rem); /* 101-140 chars */
}

.tiktok-name {
    font-size: clamp(1.8rem, 4vw, 3rem);
    font-weight: 700;
    text-shadow: 2px 2px 0px rgba(0,0,0,1);
    margin-top: 1rem;
    /* Font stack with good emoji support */
    font-family: system-ui, -apple-system, 'Segoe UI', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif;
}

/* 5 specific colors for sender names */
.name-color-1 { color: #FFFFFF; } /* White */
.name-color-2 { color: #FFA500; } /* Orange */
.name-color-3 { color: #FFD700; } /* Yellow */
.name-color-4 { color: #40E0D0; } /* Turquoise */
.name-color-5 { color: #FF69B4; } /* Pink */

/* STYLE 1: JavaScript typewriter effect */
.tiktok-style-1 {
    white-space: pre-wrap;
    word-wrap: break-word;
    max-width: 100%;
    opacity: 1;
    position: relative;
}

/* Typewriter cursor */
.tiktok-style-1::after {
    content: '|';
    animation: blinkCursor 1s infinite;
    color: white;
}

.tiktok-style-1.typing-complete::after {
    display: none;
}

@keyframes blinkCursor {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

/* STYLE 2: Clean neon glow effect - NO BLACK BORDERS */
.tiktok-style-2 {
    color: #FFFFFF;
    text-shadow:
        0 0 3px #FFFFFF,
        0 0 6px #FFFFFF,
        0 0 9px #00FFFF,
        0 0 12px #00FFFF;
    animation: neonPulse 2s ease-in-out forwards;
}

/* STYLE 2 Color Variants */
.tiktok-style-2-blue {
    color: #FFFFFF;
    text-shadow:
        0 0 3px #FFFFFF,
        0 0 6px #FFFFFF,
        0 0 9px #00FFFF,
        0 0 12px #00FFFF;
    animation: neonPulseBlue 2s ease-in-out forwards;
}

.tiktok-style-2-pink {
    color: #FFFFFF;
    text-shadow:
        0 0 3px #FFFFFF,
        0 0 6px #FFFFFF,
        0 0 9px #FF69B4,
        0 0 12px #FF69B4;
    animation: neonPulsePink 2s ease-in-out forwards;
}

.tiktok-style-2-orange {
    color: #FFFFFF;
    text-shadow:
        0 0 3px #FFFFFF,
        0 0 6px #FFFFFF,
        0 0 9px #FFA500,
        0 0 12px #FFA500;
    animation: neonPulseOrange 2s ease-in-out forwards;
}

@keyframes neonPulse {
    0% {
        opacity: 0;
        transform: scale(0.8);
        text-shadow: 0 0 2px #FFFFFF;
    }
    50% {
        opacity: 0.9;
        transform: scale(1.05);
        text-shadow:
            0 0 4px #FFFFFF,
            0 0 8px #FFFFFF,
            0 0 12px #00FFFF,
            0 0 16px #00FFFF;
    }
    100% {
        opacity: 1;
        transform: scale(1);
        text-shadow:
            0 0 3px #FFFFFF,
            0 0 6px #FFFFFF,
            0 0 9px #00FFFF,
            0 0 12px #00FFFF;
    }
}

@keyframes neonPulseBlue {
    0% {
        opacity: 0;
        transform: scale(0.8);
        text-shadow: 0 0 2px #FFFFFF;
    }
    50% {
        opacity: 0.9;
        transform: scale(1.05);
        text-shadow:
            0 0 4px #FFFFFF,
            0 0 8px #FFFFFF,
            0 0 12px #00FFFF,
            0 0 16px #00FFFF;
    }
    100% {
        opacity: 1;
        transform: scale(1);
        text-shadow:
            0 0 3px #FFFFFF,
            0 0 6px #FFFFFF,
            0 0 9px #00FFFF,
            0 0 12px #00FFFF;
    }
}

@keyframes neonPulsePink {
    0% {
        opacity: 0;
        transform: scale(0.8);
        text-shadow: 0 0 2px #FFFFFF;
    }
    50% {
        opacity: 0.9;
        transform: scale(1.05);
        text-shadow:
            0 0 4px #FFFFFF,
            0 0 8px #FFFFFF,
            0 0 12px #FF69B4,
            0 0 16px #FF69B4;
    }
    100% {
        opacity: 1;
        transform: scale(1);
        text-shadow:
            0 0 3px #FFFFFF,
            0 0 6px #FFFFFF,
            0 0 9px #FF69B4,
            0 0 12px #FF69B4;
    }
}

@keyframes neonPulseOrange {
    0% {
        opacity: 0;
        transform: scale(0.8);
        text-shadow: 0 0 2px #FFFFFF;
    }
    50% {
        opacity: 0.9;
        transform: scale(1.05);
        text-shadow:
            0 0 4px #FFFFFF,
            0 0 8px #FFFFFF,
            0 0 12px #FFA500,
            0 0 16px #FFA500;
    }
    100% {
        opacity: 1;
        transform: scale(1);
        text-shadow:
            0 0 3px #FFFFFF,
            0 0 6px #FFFFFF,
            0 0 9px #FFA500,
            0 0 12px #FFA500;
    }
}

/* STYLE 3: Bounce effect */
.tiktok-style-3 {
    color: #FFFFFF;
    text-shadow:
        3px 3px 0px #000000,
        -1px -1px 0px #000000,
        1px -1px 0px #000000,
        -1px 1px 0px #000000;
    animation: bounceIn 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3) rotate(-10deg);
    }
    50% {
        opacity: 0.9;
        transform: scale(1.2) rotate(5deg);
    }
    70% {
        opacity: 1;
        transform: scale(0.9) rotate(-2deg);
    }
    100% {
        opacity: 1;
        transform: scale(1) rotate(0deg);
    }
}

/* STYLE 4: Retro RGB Chromatic Aberration Effect - Properly centered */
.tiktok-style-4 {
    color: #FFFFFF;
    transform: rotate(-8deg) scale(0.9);
    transform-origin: center center;
    margin: 0 auto;
    max-width: 85%;
    text-shadow:
        /* Main RGB chromatic aberration layers */
        -3px 0 0 #00FFFF,          /* Cyan offset left */
        3px 0 0 #FF00FF,           /* Magenta offset right */
        0 3px 0 #FFFF00,           /* Yellow offset down */
        /* Additional depth layers for retro effect */
        -5px -2px 0 rgba(0, 255, 255, 0.6),
        5px 2px 0 rgba(255, 0, 255, 0.6),
        1px 5px 0 rgba(255, 255, 0, 0.6),
        /* Subtle outline for readability */
        -1px -1px 0 rgba(0, 0, 0, 0.8),
        1px -1px 0 rgba(0, 0, 0, 0.8),
        -1px 1px 0 rgba(0, 0, 0, 0.8),
        1px 1px 0 rgba(0, 0, 0, 0.8);
    animation: retroBounce 2s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}

@keyframes retroBounce {
    0% {
        opacity: 0;
        transform: scale(0.4) rotate(-20deg);
        text-shadow:
            -6px 0 0 #00FFFF,
            6px 0 0 #FF00FF,
            0 6px 0 #FFFF00;
    }
    30% {
        opacity: 0.8;
        transform: scale(1.0) rotate(-4deg);
        text-shadow:
            -4px 0 0 #00FFFF,
            4px 0 0 #FF00FF,
            0 4px 0 #FFFF00,
            -7px -3px 0 rgba(0, 255, 255, 0.7),
            7px 3px 0 rgba(255, 0, 255, 0.7);
    }
    70% {
        opacity: 1;
        transform: scale(0.85) rotate(-12deg);
        text-shadow:
            -2px 0 0 #00FFFF,
            2px 0 0 #FF00FF,
            0 2px 0 #FFFF00,
            -4px -1px 0 rgba(0, 255, 255, 0.5),
            4px 1px 0 rgba(255, 0, 255, 0.5);
    }
    100% {
        opacity: 1;
        transform: scale(0.9) rotate(-8deg);
        text-shadow:
            -3px 0 0 #00FFFF,
            3px 0 0 #FF00FF,
            0 3px 0 #FFFF00,
            -5px -2px 0 rgba(0, 255, 255, 0.6),
            5px 2px 0 rgba(255, 0, 255, 0.6),
            1px 5px 0 rgba(255, 255, 0, 0.6),
            -1px -1px 0 rgba(0, 0, 0, 0.8),
            1px -1px 0 rgba(0, 0, 0, 0.8),
            -1px 1px 0 rgba(0, 0, 0, 0.8),
            1px 1px 0 rgba(0, 0, 0, 0.8);
    }
}

/* Name animation - fixed timing and visibility */
.tiktok-name {
    animation: nameSlideUp 1.5s 2.5s ease-out forwards;
    opacity: 0;
    position: relative;
    z-index: 20;
}

@keyframes nameSlideUp {
    0% {
        opacity: 0;
        transform: translateY(20px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .tiktok-wish {
        font-size: clamp(2rem, 8vw, 3.5rem);
        letter-spacing: 1px;
        max-width: 90%;
    }
    
    .tiktok-name {
        font-size: clamp(1.5rem, 5vw, 2.5rem);
        bottom: 12%;
    }
}
</style>

<script>
// True character-by-character typewriter effect - ONLY for Style 1
function startTypewriter() {
    // Only select Style 1 elements that have data-text attribute and are not already processing
    const typewriterElements = document.querySelectorAll('.tiktok-style-1[data-text]:not([data-typewriter-started])');

    typewriterElements.forEach(element => {
        const text = element.getAttribute('data-text');
        if (!text) return; // Safety check

        // Mark as started to prevent multiple executions
        element.setAttribute('data-typewriter-started', 'true');

        // Clear content and start typing
        element.textContent = '';

        let index = 0;
        const speed = 80; // Slightly slower for better effect

        function typeChar() {
            if (index < text.length) {
                // Only add character if we haven't been interrupted
                if (element.hasAttribute('data-typewriter-started')) {
                    element.textContent = text.substring(0, index + 1);
                    index++;
                    setTimeout(typeChar, speed);
                }
            } else {
                // Typing complete, hide cursor and mark as done
                element.classList.add('typing-complete');
                element.setAttribute('data-typewriter-done', 'true');
            }
        }

        // Start typing after a small delay
        setTimeout(typeChar, 500);
    });
}

// Only run once when page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startTypewriter);
} else {
    startTypewriter();
}

// Handle HTMX updates - debounced to prevent multiple calls
let htmxTimeout;
document.addEventListener('htmx:afterSwap', function() {
    clearTimeout(htmxTimeout);
    htmxTimeout = setTimeout(startTypewriter, 100);
});

// Adjust image display based on aspect ratio
function adjustImageDisplay(img) {
    img.onload = function() {
        const aspectRatio = this.naturalWidth / this.naturalHeight;
        if (aspectRatio < 1) {
            // Vertical image - use gentler Ken Burns effect
            this.classList.remove('ken-burns-animation');
            this.classList.add('ken-burns-vertical');
        }
    };
}

// Adjust video display and notify parent of duration
function adjustVideoDisplay(video) {
    video.addEventListener('loadedmetadata', function() {
        const aspectRatio = this.videoWidth / this.videoHeight;
        if (aspectRatio < 1) {
            // Vertical video - no Ken Burns effect
            this.classList.remove('ken-burns-animation');
            this.classList.add('ken-burns-video');
        }

        // Notify parent window of video duration
        const duration = this.duration || 0;
        if (window.parent && duration > 0) {
            window.parent.postMessage({
                type: 'video_duration',
                duration: Math.ceil(duration)
            }, '*');
        }
    });
}

// Notify parent when video ends
function notifyVideoEnded(video) {
    if (window.parent) {
        window.parent.postMessage({
            type: 'video_ended'
        }, '*');
    }
}
</script>

